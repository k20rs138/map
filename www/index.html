<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="leaflet/leaflet.css" />
  <script src="leaflet/leaflet.js"></script>
  <script src="keys.js"></script>
  <script>
    // 変数宣言
    var map;
    var marker;
    var marker2;
    var lat;
    var lon;

    var ncmb = new NCMB(appKey, clientKey);
    var MapDataClass = ncmb.DataStore("MapData");

    function enterData(){
      var mapDataClass = new MapDataClass();
      var latData = parseInt($("#lat").val());
      var lonData = parseInt($("#lon").val());
      mapDataClass
      .set("latitude", latData)
      .set("longitude", lonData).save()
      .then(function() {
        $("#data").html("enter success");
      })
      .catch(function() {
        $("#data").html("enter fail");
      })
    }

    function dist(sx, sy, ex, ey) {
      return Math.sqrt((ex - sx) * (ex - sx) + (ey - sy) * (ey - sy));
    }

    function init() {
      $('#btnA').on("click", function(e) {
        btnAClick(e);
      });

      $('#btnB').on("click", function(e) {
        btnBClick(e);
      });

      map = L.map('map').setView([33.67038, 130.44619], 15);

      var tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
      });

      map.addLayer(tiles);
      marker = L.marker([0, 0]).addTo(map);
      marker2 = L.marker([0, 0]).addTo(map);

      map.on('click', onMapClick); 
    }

    function onMapClick(e) { 
      var mapDataClass = new MapDataClass();
      var lat = e.latlng.lat;
      var lon = e.latlng.lng;
      mapDataClass
      .set("latitude", lat)
      .set("longitude", lon).save()
      .then(function() {
        $("#data").html("緯度: " + lat + "<br>経度: " + lon);
      })
      .catch(function() {
        $("#data").html("enter fail");
      })
      
      var mk = L.marker(e.latlng).on('click', onMarkerClick).addTo(map); 
    }
    
    function onMarkerClick(e) { 
      map.removeLayer(e.target); 
    }

    function btnAClick(e) {
      navigator.geolocation.getCurrentPosition(onSuccess, onError);
    }

    function onSuccess(pos) {
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;
      marker.setLatLng([lat, lon]);
      map.panTo([lat, lon]);
      $("#data").html(lat + "<br>" + lon);
      if (lat > 33.66850 && lat < 33.67250) {
        if (lon > 130.4430 && lon < 130.4490) {
          $("#data").html(lat + "<br>" + lon + "<br>" + "Goal!!!");
        }
      }
    }

    function onError(e) {
      $("#data").html("error:" + e.name + ":" + e.message);
    }

    //
    function toCoordinates() {
      // データ取得
      checkCoordinates();
      // 座標画面へ遷移
      window.location.href = "#coordinates";
    }

    // 【mBaaS】保存したデータの検索と取得
    function checkCoordinates() {
      // 保存先クラスを作成
      var mapDataClass = ncmb.DataStore("MapData");
      // データ5件を取得するように設定する
      mapDataClass
      .limit(5)
      .fetchAll()
      .then(function(results){
        // 検索に成功した場合の処理
        console.log("検索に成功しました。");
        // テーブルにデータをセット
        setData(results);
      })
      .catch(function(error){
      // 検索に失敗した場合の処理
        console.log("検索に失敗しました。エラー:" +error);
      }); 
    }

    // テーブルにデータを設定
    function setData(array) {
      var table = document.getElementById("coordinatesTable");
      for (i=0; i<array.length; i++) {
        // 緯度の設定
        var latitude = table.rows[i].cells[1];
        latitude.innerHTML = array[i].latitude;
        // 経度の設定
        var longitude = table.rows[i].cells[2];
        longitude.innerHTML = array[i].longitude;
      }   
    }
  </script>

</head>
<body onload="init();">
<div data-role="page" id="main">
  <div data-role="header">
    <h1>メインページ</h1>
  </div>
  <div data-role="content">
    <div id="map"> </div>
    <div id="data">Data</div>
    <div>
      <label for="lat">緯度</label>
      <input id="lat" type="number" placeholder="latitude">
    </div>
    <div>
      <label for="lon">経度</label>
      <input id="lon" type="number" placeholder="longitude">
    </div>
    <input type="button" value="buttonA" name="btnA" onclick="enterData()"/>
    <input type="button" value="座標" name="btnB" onclick="toCoordinates()"/>
  </div>
</div>

<div data-role="page" id="coordinates">
  <div data-role="header">
    <h1></h1>
    <a href="#main" data-icon="back" class="ui-btn-left">戻る</a>
  </div>
  <div data-role="content">
    <center>
      <h1>座標</h1><br />
      <table id="coordinatesTable" border="1" width="90%" cellspacing="1" cellpadding="5">
        <tr>
          <td id="place_1" align="right" nowrap>-</td>
          <td id= "lat_1" align="center" width="200">no data</td>
          <td id= "lon_1"align="center" width="150">no data</td>
        </tr>
        <tr>
          <td id="place_2" align="right" nowrap>-</td>
          <td id = "lat_2" align="center" width="200">no data</td>
          <td id = "lon_2" align="center" width="150">no data</td>
        </tr>
        <tr>
          <td id="place_3" align="right" nowrap>-</td>
          <td id = "lat_3" align="center" width="200">no data</td>
          <td id = "lon_3" align="center" width="150">no data</td>
        </tr>
        <tr>
          <td id="place_4" align="right" nowrap>-</td>
          <td id = "lat_4" align="center" width="200">no data</td>
          <td id = "lon_4" align="center" width="150">no data</td>
        </tr>
        <tr>
          <td id="place_5" align="right" nowrap>-</td>
          <td id = "lat_5" align="center" width="200">no data</td>
          <td id = "lon_5" align="center" width="150">no data</td>
        </tr>
      </table> 
    </center>
  </div>
</div>

</body>

</html>