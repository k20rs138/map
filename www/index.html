<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="leaflet/leaflet.css" />
  <script src="leaflet/leaflet.js"></script>
  <script src="keys.js"></script>
  <script>
    // 変数宣言
    var map;
    var marker;
    var marker2;
    var lat;
    var lon;

    var ncmb = new NCMB(appKey, clientKey);
    var MapDataClass = ncmb.DataStore("MapData");

    function enterData(){
      var mapDataClass = new MapDataClass();
      var latData = parseInt($("#lat").val());
      var lonData = parseInt($("#lon").val());
      mapDataClass
      .set("latitude", latData)
      .set("longitude", lonData).save()
      .then(function() {
        $("#data").html("enter success");
      })
      .catch(function() {
        $("#data").html("enter fail");
      })
    }

    function dist(sx, sy, ex, ey) {
      return Math.sqrt((ex - sx) * (ex - sx) + (ey - sy) * (ey - sy));
    }

    function init() {
      $('#btnA').on("click", function(e) {
        btnAClick(e);
      });

      $('#btnB').on("click", function(e) {
        btnBClick(e);
      });

      map = L.map('map').setView([33.67038, 130.44619], 15);

      var tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
      });

      map.addLayer(tiles);
      marker = L.marker([0, 0]).addTo(map);
      marker2 = L.marker([0, 0]).addTo(map);

      map.on('click', onMapClick); 
    }

    function onMapClick(e) { 
      var mk = L.marker(e.latlng).on('click', onMarkerClick).addTo(map); 
    }
    
    function onMarkerClick(e) { 
      map.removeLayer(e.target); 
    }

    function btnAClick(e) {
      navigator.geolocation.getCurrentPosition(onSuccess, onError);
    }

    function btnBClick(e) {
      lat = 33.5897279;
      lon = 130.4206648;

      marker.setLatLng([lat, lon]);
      map.panTo([lat, lon]);
      $("#data").html("博多駅");
    }

    function onSuccess(pos) {
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;
      marker.setLatLng([lat, lon]);
      map.panTo([lat, lon]);
      $("#data").html(lat + "<br>" + lon);
      if (lat > 33.66850 && lat < 33.67250) {
        if (lon > 130.4430 && lon < 130.4490) {
          $("#data").html(lat + "<br>" + lon + "<br>" + "Goal!!!");
        }
      }
    }

    function onError(e) {
      $("#data").html("error:" + e.name + ":" + e.message);
    }
  </script>

</head>

<body onload="init();">
  <div id="map"> </div>
  <div id="data">Data</div>
  <div>
    <label for="lat">緯度</label>
    <input id="lat" type="number" placeholder="latitude">
  </div>
  <div>
    <label for="lon">経度</label>
    <input id="lon" type="number" placeholder="longitude">
  </div>
  <button id="btnA" onclick="enterData()">ButtonA</button>
  <button id="btnB">ButtonB</button>

</body>

</html>